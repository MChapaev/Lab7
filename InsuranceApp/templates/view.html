{% extends 'base.html' %}
{% load template_filters %}
{% block title %}Просмотр записей{% endblock %}
{% block content %}
    <div class="card p-4">
        <h1 class="text-center mb-4">Просмотр записей</h1>
        
        <h3>Заявки по клиенту</h3>
        <form id="byClientForm" method="post" class="mb-4">
            {% csrf_token %}
            <input type="hidden" name="query_type" value="by_client">
            <div class="mb-3">
                <label for="full_name" class="form-label">ФИО:</label>
                <input type="text" name="full_name" id="full_name" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="passport_number" class="form-label">Номер паспорта:</label>
                <input type="text" name="passport_number" id="passport_number" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Поиск</button>
            <button type="button" class="btn btn-secondary" onclick="exportJson('by_client')">Экспортировать в JSON</button>
        </form>
        <div id="byClientResults">
            {% if results and title|slice:":10" == "Заявки для" %}
            <h2>{{ title }}</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        {% for column in columns %}
                        <th>{{ column }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                    <tr>
                        {% for column in columns %}
                        <td>{{ row|get_item:column }}</td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ columns|length }}">Записи не найдены.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        <div id="byClientMessage" class="mt-3"></div>

        <h3>Все активные заявки</h3>
        <form id="activeForm" method="post" class="mb-4">
            {% csrf_token %}
            <input type="hidden" name="query_type" value="active">
            <button type="submit" class="btn btn-primary">Просмотреть активные заявки</button>
            <button type="button" class="btn btn-secondary" onclick="exportJson('active')">Экспортировать в JSON</button>
        </form>
        <div id="activeResults"></div>
        <div id="activeMessage" class="mt-3"></div>

        <h3>Заявки, сгруппированные по типу полиса</h3>
        <form id="groupForm" method="post" class="mb-4">
            {% csrf_token %}
            <input type="hidden" name="query_type" value="group_by_type">
            <button type="submit" class="btn btn-primary">Сгруппировать по типу полиса</button>
            <button type="button" class="btn btn-secondary" onclick="exportJson('group_by_type')">Экспортировать в JSON</button>
        </form>
        <div id="groupResults"></div>
        <div id="groupMessage" class="mt-3"></div>

    </div>
    <script>
        console.log('Скрипт загружен, проверка jQuery...');
        if (typeof $ === 'undefined') {
            console.error('jQuery не загружен!');
        } else {
            console.log('jQuery загружен, привязка обработчиков событий...');
        }

        $(document).ready(function() {
            console.log('Документ готов, привязка отправки формы...');

            // Обработка формы Заявки по клиенту
            const byClientForm = $('#byClientForm');
            if (byClientForm.length === 0) {
                console.error('Форма #byClientForm не найдена!');
            } else {
                console.log('Форма #byClientForm найдена, привязка события отправки...');
            }

            byClientForm.on('submit', function(e) {
                e.preventDefault();
                console.log('Отправка формы предотвращена, отправка AJAX...');
                const formData = $(this).serialize();
                console.log('Отправляемые данные формы:', formData);

                $.ajax({
                    url: '{% url 'view' %}',
                    type: 'POST',
                    data: formData,
                    beforeSend: function(xhr) {
                        const csrfToken = $('input[name=csrfmiddlewaretoken]', byClientForm).val();
                        console.log('CSRF-токен:', csrfToken);
                        xhr.setRequestHeader("X-CSRFToken", csrfToken);
                    },
                    success: function(response) {
                        console.log('Успешный AJAX:', typeof response, response);
                        if (typeof response === 'string') {
                            console.error('Получен HTML вместо JSON:', response.substring(0, 100));
                        } else if (response.success) {
                            console.log('Результаты:', response.results);
                            let html = `<h2>${response.title}</h2><table class="table table-striped"><thead><tr>`;
                            response.columns.forEach(column => html += `<th>${column}</th>`);
                            html += `</tr></thead><tbody>`;
                            response.results.forEach(row => {
                                console.log('Строка:', row);
                                html += '<tr>';
                                response.columns.forEach(column => {
                                    const key = column.toLowerCase().replace(' ', '_');
                                    const value = row[key] !== undefined ? row[key] : '';
                                    console.log(`Столбец: ${column}, Ключ: ${key}, Значение: ${value}`);
                                    html += `<td>${value}</td>`;
                                });
                                html += '</tr>';
                            });
                            html += '</tbody></table>';
                            $('#byClientResults').html(html);
                            $('#byClientMessage').html('');
                        } else {
                            $('#byClientMessage').html('<div class="alert alert-danger">' + response.message + '</div>');
                            $('#byClientResults').html('');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log('Ошибка AJAX:', status, error);
                        console.log('Текст ответа:', xhr.responseText);
                        $('#byClientMessage').html('<div class="alert alert-danger">Произошла ошибка сервера: ' + error + '</div>');
                        $('#byClientResults').html('');
                    }
                });
                return false;
            });

            // Обработка формы Все активные заявки
            const activeForm = $('#activeForm');
            if (activeForm.length === 0) {
                console.error('Форма #activeForm не найдена!');
            } else {
                console.log('Форма #activeForm найдена, привязка события отправки...');
            }

            activeForm.on('submit', function(e) {
                e.preventDefault();
                console.log('Отправка формы активных заявок предотвращена, отправка AJAX...');
                const formData = $(this).serialize();
                console.log('Данные формы активных заявок:', formData);

                $.ajax({
                    url: '{% url 'view' %}',
                    type: 'POST',
                    data: formData,
                    beforeSend: function(xhr) {
                        const csrfToken = $('input[name=csrfmiddlewaretoken]', activeForm).val();
                        console.log('CSRF-токен:', csrfToken);
                        xhr.setRequestHeader("X-CSRFToken", csrfToken);
                    },
                    success: function(response) {
                        console.log('Успешный AJAX для активных заявок:', typeof response, response);
                        if (typeof response === 'string') {
                            console.error('Получен HTML вместо JSON:', response.substring(0, 100));
                        } else if (response.success) {
                            console.log('Результаты активных заявок:', response.results);
                            let html = `<h2>${response.title}</h2><table class="table table-striped"><thead><tr>`;
                            response.columns.forEach(column => html += `<th>${column}</th>`);
                            html += `</tr></thead><tbody>`;
                            response.results.forEach(row => {
                                console.log('Строка:', row);
                                html += '<tr>';
                                response.columns.forEach(column => {
                                    const key = column.toLowerCase().replace(' ', '_');
                                    const value = row[key] !== undefined ? row[key] : '';
                                    console.log(`Столбец: ${column}, Ключ: ${key}, Значение: ${value}`);
                                    html += `<td>${value}</td>`;
                                });
                                html += '</tr>';
                            });
                            html += '</tbody></table>';
                            $('#activeResults').html(html);
                            $('#activeMessage').html('');
                        } else {
                            $('#activeMessage').html('<div class="alert alert-danger">' + response.message + '</div>');
                            $('#activeResults').html('');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log('Ошибка AJAX для активных заявок:', status, error);
                        console.log('Текст ответа:', xhr.responseText);
                        $('#activeMessage').html('<div class="alert alert-danger">Произошла ошибка сервера: ' + error + '</div>');
                        $('#activeResults').html('');
                    }
                });
                return false;
            });

            // Обработка формы Заявки, сгруппированные по типу полиса
            const groupForm = $('#groupForm');
            if (groupForm.length === 0) {
                console.error('Форма #groupForm не найдена!');
            } else {
                console.log('Форма #groupForm найдена, привязка события отправки...');
            }

            groupForm.on('submit', function(e) {
                e.preventDefault();
                console.log('Отправка формы группировки предотвращена, отправка AJAX...');
                const formData = $(this).serialize();
                console.log('Данные формы группировки:', formData);

                $.ajax({
                    url: '{% url 'view' %}',
                    type: 'POST',
                    data: formData,
                    beforeSend: function(xhr) {
                        const csrfToken = $('input[name=csrfmiddlewaretoken]', groupForm).val();
                        console.log('CSRF-токен:', csrfToken);
                        xhr.setRequestHeader("X-CSRFToken", csrfToken);
                    },
                    success: function(response) {
                        console.log('Успешный AJAX для группировки:', typeof response, response);
                        if (typeof response === 'string') {
                            console.error('Получен HTML вместо JSON:', response.substring(0, 100));
                        } else if (response.success) {
                            console.log('Результаты группировки:', response.results);
                            let html = `<h2>${response.title}</h2><table class="table table-striped"><thead><tr>`;
                            response.columns.forEach(column => html += `<th>${column}</th>`);
                            html += `</tr></thead><tbody>`;
                            response.results.forEach(row => {
                                console.log('Строка:', row);
                                html += '<tr>';
                                response.columns.forEach(column => {
                                    const key = column.toLowerCase().replace(' ', '_');
                                    const value = row[key] !== undefined ? row[key] : '';
                                    console.log(`Столбец: ${column}, Ключ: ${key}, Значение: ${value}`);
                                    html += `<td>${value}</td>`;
                                });
                                html += '</tr>';
                            });
                            html += '</tbody></table>';
                            $('#groupResults').html(html);
                            $('#groupMessage').html('');
                        } else {
                            $('#groupMessage').html('<div class="alert alert-danger">' + response.message + '</div>');
                            $('#groupResults').html('');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log('Ошибка AJAX для группировки:', status, error);
                        console.log('Текст ответа:', xhr.responseText);
                        $('#groupMessage').html('<div class="alert alert-danger">Произошла ошибка сервера: ' + error + '</div>');
                        $('#groupResults').html('');
                    }
                });
                return false;
            });
        });

        function exportJson(queryType) {
            let url = '{% url 'view' %}?query_type=' + queryType + '&export=json';
            if (queryType === 'by_client') {
                const form = $('#byClientForm').serialize();
                url = '{% url 'view' %}?' + form + '&export=json';
            } else if (queryType === 'active' || queryType === 'group_by_type') {
                url += '&export=json';
            }
            window.location.href = url;
        }
    </script>
{% endblock %}